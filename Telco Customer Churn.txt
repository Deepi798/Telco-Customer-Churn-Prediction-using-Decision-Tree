import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeClassifier
from sklearn.metrics import roc_auc_score, classification_report, confusion_matrix
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

# --- 1. Data Loading and Cleaning ---
df = pd.read_csv("WA_Fn-UseC_-Telco-Customer-Churn (1).csv")

df['TotalCharges'] = pd.to_numeric(df['TotalCharges'], errors='coerce')
df['TotalCharges'] = df['TotalCharges'].fillna(0)

df = df.drop('customerID', axis=1)

# --- 2. Data Preparation ---
y = df['Churn'].map({'Yes': 1, 'No': 0})
X = df.drop('Churn', axis=1)

X_encoded = pd.get_dummies(X, drop_first=True)

X_train, X_test, y_train, y_test = train_test_split(
    X_encoded, y, test_size=0.2, random_state=42, stratify=y
)

# --- 3. Model Training ---
dt_classifier = DecisionTreeClassifier(random_state=42, max_depth=5)
dt_classifier.fit(X_train, y_train)

y_pred = dt_classifier.predict(X_test)

print("\n--- Model Evaluation ---")
print(f"Accuracy: {dt_classifier.score(X_test, y_test):.4f}")

print("\nClassification Report:")
print(classification_report(y_test, y_pred))

# --- 4. Confusion Matrix ---
cm = confusion_matrix(y_test, y_pred)
print("\nConfusion Matrix:")
print(cm)

# OPTIONAL: Plot confusion matrix as heatmap
plt.figure(figsize=(6,4))
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues',
            xticklabels=['No Churn', 'Churn'],
            yticklabels=['No Churn', 'Churn'])
plt.xlabel('Predicted')
plt.ylabel('Actual')
plt.title('Confusion Matrix for Decision Tree')
plt.show()

# --- 5. Top 5 Features ---
feature_importances = pd.Series(dt_classifier.feature_importances_, index=X_encoded.columns)
top_5_features = feature_importances.nlargest(5)

print("\n--- Top 5 Features Driving Churn ---")
print(top_5_features)
